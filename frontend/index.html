<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Source Medical AI Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 32px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .system-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }

        .system-info h3 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .system-info ul {
            list-style: none;
            padding: 0;
        }

        .system-info li {
            padding: 6px 0;
            color: #4a5568;
            display: flex;
            align-items: center;
        }

        .system-info .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .system-info .status.online {
            background: #48bb78;
            box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.3);
        }

        .system-info .status.offline {
            background: #f56565;
            box-shadow: 0 0 0 2px rgba(245, 101, 101, 0.3);
        }

        .chat-container {
            margin-bottom: 32px;
        }

        .messages {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            background: #f8fafc;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .user-message {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: white;
            color: #2d3748;
            margin-right: auto;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message .risk-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .message .risk-level.low {
            background: #c6f6d5;
            color: #22543d;
        }

        .message .risk-level.moderate {
            background: #fef5e7;
            color: #c05621;
        }

        .message .risk-level.high {
            background: #fed7d7;
            color: #c53030;
        }

        .message .risk-level.critical {
            background: #fc8181;
            color: white;
            animation: pulse 2s infinite;
        }

        .emergency-warning {
            background: linear-gradient(45deg, #fc8181, #f56565);
            color: white;
            border: 2px solid #e53e3e;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 12px 0;
            font-weight: 600;
            animation: pulse 2s infinite;
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        #messageInput {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        #messageInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #4a5568;
            color: white;
        }

        .btn-secondary:hover {
            background: #2d3748;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-2px);
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .status {
            text-align: center;
            padding: 12px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .status.recording {
            background: #fef5e7;
            color: #c05621;
            border: 1px solid #f6ad55;
        }

        .status.processing {
            background: #e6fffa;
            color: #234e52;
            border: 1px solid #4fd1c7;
        }

        .status.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #fc8181;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #68d391;
        }

        .hidden {
            display: none !important;
        }

        .record-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            animation: pulse 1s infinite;
        }

        .disclaimer {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 16px;
            padding: 20px;
            margin-top: 24px;
            font-size: 0.9rem;
            color: #742a2a;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #c53030;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .feature-item {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #bee3f8;
            text-align: center;
            font-size: 0.9rem;
        }

        .recommendations {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .recommendations h4 {
            color: #22543d;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }

        .recommendations li {
            margin-bottom: 4px;
            color: #2f855a;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .messages {
                height: 300px;
            }
            
            .input-container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Medical AI Assistant</h1>
            <p>Open-Source Medical AI System</p>
            <span class="badge">🔓 No API Keys Required</span>
        </div>

        <div id="systemInfo" class="system-info">
            <h3>🛠️ System Status</h3>
            <div class="loading"></div> Loading system information...
        </div>

        <div class="chat-container">
            <div id="messages" class="messages">
                <div class="message bot-message">
                    👋 <strong>Welcome to your Open-Source Medical AI Assistant!</strong>
                    <br><br>
                    I can help you with:
                    <div class="feature-grid">
                        <div class="feature-item">🏥 General health information</div>
                        <div class="feature-item">📋 Symptom guidance</div>
                        <div class="feature-item">💊 Medication information</div>
                        <div class="feature-item">🏃‍♂️ Wellness tips</div>
                        <div class="feature-item">🎙️ Voice interactions</div>
                        <div class="feature-item">🔬 Medical research</div>
                    </div>
                    <br>
                    <strong>✨ Features:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li>🔓 Completely open-source</li>
                        <li>🖥️ Runs locally on your device</li>
                        <li>🔒 Your data stays private</li>
                        <li>⚡ No subscription fees</li>
                        <li>🧠 Multiple AI models available</li>
                    </ul>
                    <br>
                    <strong>🚨 Important:</strong> For medical emergencies, call 911 immediately!
                </div>
            </div>

            <div id="status" class="status hidden"></div>

            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Ask me anything about health and medicine..." />
                <button class="btn btn-primary" onclick="sendMessage()">
                    <span>💬</span> Send
                </button>
            </div>

            <div class="controls">
                <button id="recordBtn" class="record-btn" onclick="toggleRecording()" title="Voice Message">
                    🎤
                </button>
                <button class="btn btn-secondary" onclick="clearChat()">
                    🗑️ Clear
                </button>
                <button class="btn btn-success" onclick="loadSystemInfo()">
                    🔄 Refresh
                </button>
                <button class="btn btn-warning" onclick="showModels()">
                    🤖 Models
                </button>
            </div>
        </div>

        <div class="disclaimer">
            <strong>⚠️ Medical Disclaimer:</strong> This AI assistant provides general health information for educational purposes only. It uses open-source language models and should not replace professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare professionals for medical concerns.
        </div>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let systemInfo = null;
        const API_BASE_URL = 'http://localhost:8000';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Load system information
            loadSystemInfo();
        });

        async function loadSystemInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/models/system-info`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                systemInfo = data;
                
                const systemInfoDiv = document.getElementById('systemInfo');
                systemInfoDiv.innerHTML = `
                    <h3>🛠️ System Status</h3>
                    <ul>
                        <li><span class="status ${data.llm_info.is_loaded ? 'online' : 'offline'}"></span> 
                            <strong>LLM Model:</strong> ${data.llm_info.model_name}</li>
                        <li><span class="status ${data.voice_info.whisper_available ? 'online' : 'offline'}"></span> 
                            <strong>Voice Recognition:</strong> ${data.voice_info.whisper_available ? 'Whisper (' + data.voice_info.current_whisper_model + ')' : 'Unavailable'}</li>
                        <li><span class="status ${data.voice_info.gtts_available ? 'online' : 'offline'}"></span> 
                            <strong>Text-to-Speech:</strong> ${data.voice_info.gtts_available ? 'gTTS' : 'Unavailable'}</li>
                        <li><span class="status ${data.knowledge_base_available ? 'online' : 'offline'}"></span> 
                            <strong>Knowledge Base:</strong> ${data.knowledge_base_available ? 'Available' : 'Unavailable'}</li>
                        <li><span class="status ${data.voice_info.torch_available ? 'online' : 'offline'}"></span> 
                            <strong>GPU Acceleration:</strong> ${data.voice_info.torch_available ? 'Available (' + data.voice_info.gpu_count + ' GPUs)' : 'CPU Only'}</li>
                    </ul>
                `;
                
            } catch (error) {
                console.error('Error loading system info:', error);
                const systemInfoDiv = document.getElementById('systemInfo');
                systemInfoDiv.innerHTML = `
                    <h3>🛠️ System Status</h3>
                    <p style="color: #c53030;">❌ Unable to connect to backend. Please ensure the server is running on port 8000.</p>
                    <p style="color: #4a5568; margin-top: 8px;">Run: <code>uvicorn backend.main:app --reload</code></p>
                `;
            }
        }

        async function showModels() {
            try {
                const response = await fetch(`${API_BASE_URL}/models/available`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                let modelInfo = '<strong>🤖 Available Models:</strong><br><br>';
                
                modelInfo += '<strong>LLM Models:</strong><br>';
                for (const [key, value] of Object.entries(data.llm_models)) {
                    modelInfo += `• ${value.name} (${value.memory_gb}GB) - ${value.description}<br>`;
                }
                
                modelInfo += '<br><strong>Voice Models:</strong><br>';
                for (const [key, value] of Object.entries(data.voice_models.whisper)) {
                    modelInfo += `• Whisper ${key} - ${value.size}, ${value.speed} speed, ${value.accuracy} accuracy<br>`;
                }
                
                modelInfo += '<br><strong>Current Configuration:</strong><br>';
                modelInfo += `• LLM: ${data.current_llm.model_name}<br>`;
                modelInfo += `• Voice: ${data.voice_models.current_model}<br>`;
                
                addMessage(modelInfo);
                
            } catch (error) {
                console.error('Error loading models:', error);
                addMessage('❌ Could not load model information.');
            }
        }

        function showStatus(message, type = 'processing') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = type === 'processing' ? 
                `<div class="loading"></div> ${message}` : message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        function addMessage(message, isUser = false, data = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            let messageContent = message;
            
            if (!isUser && data) {
                // Add emergency warning
                if (data.is_emergency) {
                    messageContent = `<div class="emergency-warning">🚨 MEDICAL EMERGENCY DETECTED</div>${messageContent}`;
                }
                
                // Add risk level
                if (data.risk_level && data.risk_level !== 'low') {
                    messageContent += `<div class="risk-level ${data.risk_level}">Risk Level: ${data.risk_level}</div>`;
                }
                
                // Add recommendations
                if (data.recommendations && data.recommendations.length > 0) {
                    messageContent += '<div class="recommendations">';
                    messageContent += '<h4>📋 Recommendations:</h4><ul>';
                    data.recommendations.forEach(rec => {
                        messageContent += `<li>${rec}</li>`;
                    });
                    messageContent += '</ul></div>';
                }
                
                // Add metadata
                const metadata = [];
                if (data.confidence_score) {
                    const confidence = Math.round(data.confidence_score * 100);
                    metadata.push(`🎯 Confidence: ${confidence}%`);
                }
                if (data.sources && data.sources.length > 0) {
                    metadata.push(`📚 Sources: ${data.sources.join(', ')}`);
                }
                
                if (metadata.length > 0) {
                    messageContent += `<br><br><small>${metadata.join(' • ')}</small>`;
                }
            }
            
            messageDiv.innerHTML = messageContent;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            showStatus('🤖 Processing your medical question...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                addMessage(data.response, false, data);
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage(`❌ Sorry, I'm having trouble processing your request. Please ensure the backend server is running and try again.`);
                showStatus('Connection error', 'error');
                setTimeout(hideStatus, 3000);
                return;
            }
            
            hideStatus();
        }

        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            
            if (!systemInfo || !systemInfo.voice_info.whisper_available) {
                showStatus('❌ Voice recognition not available', 'error');
                setTimeout(hideStatus, 3000);
                return;
            }
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                        sendVoiceMessage(blob);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    recordBtn.innerHTML = '⏹️';
                    showStatus('🎤 Recording... Click to stop', 'recording');
                    
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    showStatus('❌ Microphone access denied', 'error');
                    setTimeout(hideStatus, 3000);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtn.innerHTML = '🎤';
                showStatus('🔄 Processing voice message...');
            }
        }

        async function sendVoiceMessage(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio_file', audioBlob, 'voice_message.wav');
                
                const response = await fetch(`${API_BASE_URL}/voice/chat`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Add transcription as user message
                addMessage(`🎤 "${data.transcription}"`, true);
                
                // Add bot response
                addMessage(data.response, false, data);
                
            } catch (error) {
                console.error('Error sending voice message:', error);
                addMessage(`❌ Sorry, I couldn't process your voice message. Please try typing your question instead.`);
            }
            
            hideStatus();
        }

        function clearChat() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="message bot-message">
                    👋 <strong>Welcome to your Open-Source Medical AI Assistant!</strong>
                    <br><br>
                    I can help you with:
                    <div class="feature-grid">
                        <div class="feature-item">🏥 General health information</div>
                        <div class="feature-item">📋 Symptom guidance</div>
                        <div class="feature-item">💊 Medication information</div>
                        <div class="feature-item">🏃‍♂️ Wellness tips</div>
                        <div class="feature-item">🎙️ Voice interactions</div>
                        <div class="feature-item">🔬 Medical research</div>
                    </div>
                    <br>
                    <strong>✨ Features:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li>🔓 Completely open-source</li>
                        <li>🖥️ Runs locally on your device</li>
                        <li>🔒 Your data stays private</li>
                        <li>⚡ No subscription fees</li>
                        <li>🧠 Multiple AI models available</li>
                    </ul>
                    <br>
                    <strong>🚨 Important:</strong> For medical emergencies, call 911 immediately!
                </div>
            `;
        }
    </script>
</body>
</html>
